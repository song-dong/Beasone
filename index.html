<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <link rel="stylesheet" href="css/cafe-style.css">
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="js/multiparty.js"></script>
    <script type="text/javascript" src="https://skyway.io/dist/adapter.js"></script>
    <script type="text/javascript" src="https://skyway.io/dist/0.3/peer.js"></script>
    <script type="text/javascript" src="https://skyway.io/dist/screenshare.js"></script>
    <script type="text/javascript" src="js/app.js"></script>
    <style>
        .my-video {
            width: 160px;
        }

    </style>
    <style>
        .peer-video {
            width: 420px;
        }

    </style>

</head>

<body>
    <div class="room-wrapper">
        <div class="videochat-wrapper">

            <div class="videochat-header">
                <div class="room-url">
                    <p class="room-name">room name</p>
                </div>
                <button class="url-copy">Copy link</button>
            </div>
            <div class="videochat-group">
                <div class="videochat-room">
                    <div id="peerVideo1" class="video-box">

                    </div>
                    <div class="user-name">
                        user name
                    </div>
                </div>

                <div class="videochat-room">
                    <div id="peerVideo2" class="video-box">

                    </div>
                    <div class="user-name">
                        user name
                    </div>
                </div>
            </div>

            <div class="my-videochat-room">
                <div id="myVideo" class="video-box">
                </div>
                <video id="myScreen" muted="true" width="480" height="240" autoplay></video>
                <p><label>Width : </label><input id="Width" size="5" value="640"></p>
                <p><label>Height : </label><input id="Height" size="5" value="480"></p>
                <p><label>FrameRate : </label><input id="FrameRate" size="5" value="1"></p>
            </div>

            <div class="video-toolbar">
                <div class="video-toolbar-group">
                    <button id="video-mute" data-muted="false" class="video-button">
                        <svg version="1.1" id="_x32_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="512px" height="512px" viewBox="0 0 512 512" style="width: 30px; height: 30px; opacity: 1;" xml:space="preserve">
                            <style type="text/css">
                                .st0{fill:#4B4B4B;}

                            </style>
                            <g>
                            	<path class="st0" d="M284.719,129.453H25.344c-14,0-25.344,11.328-25.344,25.328v202.422c0,14,11.344,25.344,25.344,25.344h259.375
                            		c14,0,25.344-11.344,25.344-25.344V154.781C310.063,140.781,298.719,129.453,284.719,129.453z" style="fill: rgb(75, 75, 75);"></path>
                            	<path class="st0" d="M502.313,174.547c-6.125-4.797-14.094-6.516-21.656-4.688L357,199.984
                            		c-11.375,2.766-19.359,12.938-19.359,24.641v60c0,11.688,7.984,21.859,19.359,24.625l123.656,30.141
                            		c7.563,1.813,15.531,0.094,21.656-4.703c6.109-4.813,9.688-12.156,9.688-19.922V194.484
                            		C512,186.703,508.422,179.359,502.313,174.547z" style="fill: rgb(75, 75, 75);"></path>
                            </g>
                        </svg>
                        <div class="video-toolbar-itemtext">Video</div>
                    </button>
                    <button id="audio-mute" data-muted="false" class="mic-button">
                        <svg version="1.1" id="_x32_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="width: 30px; height: 30px; opacity: 1;" xml:space="preserve">
                            <style type="text/css">
                        	    .st0{fill:#4B4B4B;}
                            </style>
                            <g>
                        	    <path class="st0" d="M401.013,218.24v26.71c-0.012,40.006-16.224,76.154-42.518,102.482c-26.33,26.294-62.477,42.518-102.484,42.53
                        		    c-40.018-0.012-76.165-16.236-102.494-42.53c-26.295-26.329-42.519-62.476-42.53-102.482v-26.71H75.589v26.71
                        		    c0.034,91.502,68.445,167.044,156.824,178.682V512h47.197v-88.368c88.368-11.638,156.766-87.18,156.802-178.682v-26.71H401.013z" style="fill: rgb(75, 75, 75);"></path>
                        	    <path class="st0" d="M256.011,325.067c44.201-0.012,80.106-35.928,80.117-80.117V80.129C336.118,35.928,300.212,0.012,256.011,0
                        		    c-44.201,0.012-80.117,35.928-80.129,80.129V244.95C175.894,289.139,211.81,325.055,256.011,325.067z" style="fill: rgb(75, 75, 75);"></path>
                            </g>
                        </svg>

                        <div class="video-toolbar-itemtext">Microphone</div>
                    </button>
                    <button class="translation-button">
                        <svg version="1.1" id="_x32_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="width: 30px; height: 30px; opacity: 1;" xml:space="preserve">
                            <style type="text/css">
                            	.st0{fill:#4B4B4B;}
                            </style>
                            <g>
                            	<path class="st0" d="M164.128,155.406c-0.017-11.098-0.017-20.759,1.346-29.9l-7.987,9.166
                            		c-14.001,16.134-49.379,26.563-79.029,23.301c-29.666-3.262-42.346-18.986-28.345-35.128l105.4-110.292
                            		c2.049-2.15,2.626-5.311,1.456-8.054c-1.163-2.727-3.856-4.5-6.825-4.5h-16.978c-4.968,0-9.719,1.982-13.206,5.52L28.527,98.174
                            		c-18.76,19.638-17.89,30.544-17.89,61.089c0,21.812,0,301.06,0,301.06c0,26.196,32.92,47.824,62.578,51.078
                            		c29.65,3.27,70.272-7.168,84.273-23.302l9.317-10.832c-1.673-5.402-2.676-11.04-2.676-16.945V155.406z" style="fill: rgb(75, 75, 75);"></path>
                            	<path class="st0" d="M493.952,0h-18.375c-5.36,0-10.454,2.324-13.984,6.356l-111.84,128.316c-14,16.134-49.379,26.563-79.02,23.301
                            		c-29.667-3.262-42.346-18.986-28.345-35.128l105.4-110.292c2.041-2.15,2.626-5.311,1.456-8.054c-1.172-2.727-3.856-4.5-6.825-4.5
                            		H325.44c-4.968,0-9.727,1.982-13.206,5.52l-91.432,92.654c-18.76,19.638-17.89,30.544-17.89,61.089c0,21.812,0,301.06,0,301.06
                            		c0,26.196,32.92,47.824,62.569,51.078c29.658,3.27,70.272-7.168,84.272-23.302L487.896,327.64
                            		c8.69-10.103,13.474-22.984,13.474-36.315V7.418C501.37,3.328,498.051,0,493.952,0z" style="fill: rgb(75, 75, 75);"></path>
                            </g>
                        </svg>
                        <div class="video-toolbar-itemtext">Translation</div>
                    </button>
                    <button id="screenShare" class="share-button">
                        <svg version="1.1" id="_x32_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="width: 30px; height: 30px; opacity: 1;" xml:space="preserve">
                            <style type="text/css">
	                            .st0{fill:#fffffd;}
                            </style>
                            <g>
	                            <path class="st0" d="M510.163,392.022l-45.59-57.326V93.611c0-11.662-9.458-21.12-21.12-21.12H68.546
                            		c-11.662,0-21.115,9.458-21.115,21.12v241.085L1.837,392.022C0.648,393.517,0,395.367,0,397.287v25.373
                            		c0,9.311,7.542,16.849,16.849,16.849h478.302c9.307,0,16.849-7.538,16.849-16.849v-25.373
                            		C512,395.367,511.356,393.517,510.163,392.022z M77.226,102.291h357.548v202.606H77.226V102.291z M304.121,419.47h-96.242v-25.478
                            		h96.242V419.47z" style="fill: rgb(75, 75, 75);"></path>
                            </g>
                        </svg>

                        <div class="video-toolbar-itemtext">ShareScreen</div>
                    </button>
                </div>
            </div>
        </div>
        <div id="message" class="messages-wrapper">
            <p>message</p>
            <!--..imageできるから表示してみる comment✖️2 cafe風にチョークアート...-->
            <!--1人１色でも楽しそうだし直感的に分かりやすそう。-->
            <div class="comment-body" id="comment1">
                <p class="user-comment">Hallo!!! test test test!!!</p>
            </div>
            <div class="comment-body" id="comment2">
                <p class="user-comment">♪</p>
            </div>
            <div class="comment-body" id="comment3">
                <p class="user-comment">comment comment comment</p>
            </div>
            <div class="comment-body" id="comment4">
                <svg version="1.1" id="_x32_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="30px" height="30px" viewBox="0 0 512 512" style="width: 64px; height: 64px; opacity: 1;" xml:space="preserve">
                    <style type="text/css">
                        .st0{fill:#4B4B4B;}
                    </style>
                    <g>
                    	<path class="st0" d="M462.938,198.933c-9.688,0-43.437,0-92.562,0c-39.5,0-47.094-6.656-47.094-17.297
                    		c0-12.156,19.75-33.406,24.313-41.016c4.563-7.594,33.422-33.406,39.5-71.391s-39.5-65.328-54.688-39.5
                    		c-9.016,15.328-31.906,60.766-59.25,80.516c-50.719,36.641-92.672,116.391-145.516,116.391v199.281
                    		c43.547,0,142.203,48.406,177.156,55.406c39.578,7.922,91.297,25.406,118.75-11.875c16.921-22.984,43.437-112.219,63.343-175.5
                    		C537.376,245.448,502.517,198.933,462.938,198.933z" style="fill: rgb(255, 255, 255);"></path>
                    	<path class="st0" d="M0.001,265.401v173.203c0,21.406,17.344,38.766,38.75,38.766h22.031c14.266,0,25.844-11.563,25.844-25.844
                    		V226.636H38.751C17.345,226.636,0.001,243.995,0.001,265.401z" style="fill: rgb(255, 255, 255);"></path>
                    </g>
                </svg>
            </div>
            <form>
                <input type="text"><button type="submit">send</button>
            </form>
            <p class="receive"></p>
        </div>
    </div>


    <script>
        var multiparty;

        function start() {

            // MultiParty インスタンスを生成
            multiparty = new MultiParty({
                "key": "1061e0f9-3006-4af2-8266-82ce6c34b677" /* SkyWay key */ ,
                "reliable": true /* Use reliable communication(SCTP) in Data Channel. */ ,
                //            "room": "group A",
                "debck": 3
            });


            /////////////////////////////////
            // for MediaStream
            multiparty.on('my_ms', function(video) {
                // 自分のvideoを表示
                var vNode = MultiParty.util.createVideoNode(video);
                vNode.setAttribute("class", "video my-video");
                vNode.volume = 0;
                $(vNode).appendTo("#myVideo");
            }).on('peer_ms', function(video) {
                console.log("video received!!")
                // peerのvideoを表示
                console.log(video);
                var vNode = MultiParty.util.createVideoNode(video);
                vNode.setAttribute("class", "video peer-video");
                $(vNode).appendTo("#peerVideo1");
            }).on('ms_close', function(peer_id) {
                // peerが切れたら、対象のvideoノードを削除する
                $("#" + peer_id).remove();
            })

            ////////////////////////////////
            // for DataChannel
            multiparty.on('message', function(mesg) {
                // peerからテキストメッセージを受信
                $("p.receive").append(mesg.data + "<br>");
            });
            ////////////////////////////////
            // Error handling
            multiparty.on('error', function(err) {
                alert(err);
            });

            multiparty.start();

            //////////////////////////////////////////////////////////
            // テキストフォームに入力されたテキストをpeerに送信
            $("#message form").on("submit", function(ev) {
                ev.preventDefault(); // onsubmitのデフォルト動作（reload）を抑制
                // テキストデータ取得
                var $text = $(this).find("input[type=text]");
                var data = $text.val();
                if (data.length > 0) {
                    data = data.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    $("p.receive").append(data + "<br>");
                    // メッセージを接続中のpeerに送信する
                    multiparty.send(data);
                    $text.val("");
                }
            });

            ///////////////////////////////////////////////////
            // Screen share
//            $("#screenShare").on('click', function() {
//                console.log(multiparty)
//                multiparty.startScreenShare(function(stream) {
//                    $("#myVideo").prop("src", URL.createObjectURL(stream));
//                    // success callback
//                }, function(err) {
//                    // error callback
//                });

                //                                    multiparty.stopScreenShare();
//            });


            ///////////////////////////////////////////////////
            // handle mute/unmute
            $("#video-mute").on("click", function(ev) {
                var mute = !$(this).data("muted");
                multiparty.mute({
                    video: mute
                });
                $(this).text("video " + (mute ? "unmute" : "mute")).data("muted", mute);
            });
            $("#audio-mute").on("click", function(ev) {
                var mute = !$(this).data("muted");
                multiparty.mute({
                    audio: mute
                });
                $(this).text("audio " + (mute ? "unmute" : "mute")).data("muted", mute);
            });

        }

        start();

    </script>


</body>

</html>
